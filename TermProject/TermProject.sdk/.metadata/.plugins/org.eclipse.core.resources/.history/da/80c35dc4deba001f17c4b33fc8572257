
/*
 * main.c
 *
 *  Created on: 2024. 12. 14.
 *      Author: foodbug
 */



#include "myoledrgb.h"
#include "mydcmotor.h"
#include "mymaxsonar.h"
#include "xgpio.h"

#include "stdio.h"
#include "xparameters.h"
#include "xil_io.h"
#include "xil_printf.h"


XGpio Gpio;		// 4 LED

// Base address of the OLED controller
#define OLED_BASEADDR XPAR_MYOLEDRGB_0_S00_AXI_BASEADDR
#define MAXSONAR_BASEADDR XPAR_MYMAXSONAR_0_S00_AXI_BASEADDR
#define DCMOTOR_BASEADDR XPAR_MYDCMOTOR_0_S00_AXI_BASEADDR

// OLED register offsets
#define INIT_START  0x00  // INIT_START
#define MODE    	0x04  // MODE
#define INIT_DONE   0x08  // INIT DONE

// DC Motor register offsets
#define D_DUTY  			0x00
#define D_DIV_FACTOR  		0x04
#define D_EN  				0x08

// Buzzer register offsets
#define B_DISTANCE  		0x00
#define B_BUZZER  			0x04
#define B_EN  				0x08


void Delay(unsigned int delay) {
    volatile unsigned int d;
    for (d = 0; d < delay; d++);
}


void StartINIT(unsigned int value) {
    if (value)
    	MYOLEDRGB_mWriteReg(OLED_BASEADDR, INIT_START, 1);  // Start
    else
    	MYOLEDRGB_mWriteReg(OLED_BASEADDR, INIT_START, 0);
}

void SetMODE(unsigned int value) {
	MYOLEDRGB_mWriteReg(OLED_BASEADDR, MODE, value);  // Reset Inactive
}

int main() {
	int sw_state=0;

	XGpio_Initialize(&Gpio, XPAR_AXI_GPIO_0_DEVICE_ID);

	printf("Start\n");

	Delay(30000);
	StartINIT(1);
	Delay(30000);
	StartINIT(0);


	xil_printf("INIT DONE : %d\n",MYOLEDRGB_mReadReg(OLED_BASEADDR, INIT_DONE) & 0x1);


	while (1) {
		// Read SW state
		sw_state = XGpio_DiscreteRead(&Gpio, 1);

		Delay(1e8);
	};

	xil_printf("End\n");
    return 0;
}

