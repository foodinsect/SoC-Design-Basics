/*
 * main.c
 *
 *  Created on: 2024. 12. 14.
 *      Author: foodbug
 */



#include "myoledrgb.h"
#include "mydcmotor.h"
#include "mymaxsonar.h"
#include "stdio.h"
#include "xparameters.h"
#include "xil_io.h"
#include "xil_printf.h"

// Base address of the OLED controller
#define OLED_BASEADDR XPAR_MYOLEDRGB_0_S00_AXI_BASEADDR
#define MAXSONAR_BASEADDR XPAR_MYMAXSONAR_0_S00_AXI_BASEADDR
#define DCMOTOR_BASEADDR XPAR_MYDCMOTOR_0_S00_AXI_BASEADDR

// OLED controller register offsets
#define INIT_START  0x00  // INIT_START
#define MODE    	0x04  // MODE
#define INIT_DONE   0x08  // INIT DONE

#define SET_POINT  	0x00
#define Kp  		0x04
#define Kd  		0x08
#define Ki  		0x0C

void Delay(unsigned int delay) {
    volatile unsigned int d;
    for (d = 0; d < delay; d++);
}

void pidINIT(){
	MYDCMOTOR_mWriteReg(DCMOTOR_BASEADDR, SET_POINT, 64);  // Reset Inactive
	MYDCMOTOR_mWriteReg(DCMOTOR_BASEADDR, Kp, 0x0059);  // Reset Inactive
	MYDCMOTOR_mWriteReg(DCMOTOR_BASEADDR, Kd, 0x0480);  // Reset Inactive
	MYDCMOTOR_mWriteReg(DCMOTOR_BASEADDR, Ki, 0x0000);  // Reset Inactive
}

void StartINIT(unsigned int value) {
    if (value)
    	MYOLEDRGB_mWriteReg(OLED_BASEADDR, INIT_START, 1);  // Reset Inactive
    else
    	MYOLEDRGB_mWriteReg(OLED_BASEADDR, INIT_START, 0);  // Reset Active (Low)
}

void SetMODE(unsigned int value) {
	MYOLEDRGB_mWriteReg(OLED_BASEADDR, MODE, value);  // Reset Inactive
}

int main() {

//	pidINIT();
	printf("Start\n");

//	SetMODE(0);
	Delay(30000);
	StartINIT(1);
	Delay(30000);
	StartINIT(0);


	xil_printf("INIT DONE : %d\n",MYOLEDRGB_mReadReg(OLED_BASEADDR, INIT_DONE) & 0x1);
//	xil_printf("MODE : %d\n",MYOLEDRGB_mReadReg(OLED_BASEADDR, MODE));



//	SetMODE(1);

	xil_printf("INIT DONE : %d\n",MYOLEDRGB_mReadReg(OLED_BASEADDR, INIT_DONE) & 0x1);
//	xil_printf("MODE : %d\n",MYOLEDRGB_mReadReg(OLED_BASEADDR, MODE));
	xil_printf("End\n");

	while (1) {
		xil_printf("Distance : %d\n",MYOLEDRGB_mReadReg(MAXSONAR_BASEADDR, 8));
		Delay(1e8);
	};


    return 0;
}

