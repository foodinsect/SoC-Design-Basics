# Wishbone-Bus

## 1. Synchronous On-Chip Bus Interface
- **정의**: 동기식 온칩 버스 인터페이스는 칩 내부의 다양한 모듈 간 데이터와 신호를 클록 신호에 맞춰 전달하는 구조이다.  
이는 안정적인 데이터 전송과 타이밍을 보장하는 동시에 Metastability 문제를 최소화할 수 있다.
- **메타 안정성(Metastability)**: 동기식 버스에서는 메타 안정성이 발생할 수 있다.  
이는 클럭 엣지에서 입력 신호가 변경될 때 플립플롭이 확실한 상태를 가지지 못하여 중간 상태에 머무는 현상이다.  
메타 안정성은 데이터 오류와 시스템 불안정을 유발할 수 있기 때문에, 동기화 회로를 추가하여 이를 줄이는 것이 중요하다. 
  - **해결 방법**: 메타 안정성을 줄이기 위해 일반적으로 두 개 이상의 플립플롭을 직렬로 배치하는 동기화 체인이 사용된다.  
  이를 통해 메타 안정성이 발생하더라도 다음 클럭 주기에서 안정된 상태로 신호가 전파되도록 한다.
  
- **비동기식 버스(Asynchronous Bus)**: 비동기식 버스는 클럭 신호 없이 데이터 전송이 이루어지며, 과거에 레거시 시스템에서 주로 사용되었다.  
비동기 방식은 복잡한 제어 논리가 필요하며 메타 안정성 문제가 더 빈번하게 발생할 수 있다.  
최신 시스템에서는 이러한 문제를 피하기 위해 대부분 동기식 버스 구조를 채택하고 있다.
  - **Legacy 시스템**: 비동기식 버스는 구형 시스템에서 사용되었지만, 높은 신뢰성과 속도가 요구되는 현대의 시스템에서는 주로 동기식 버스가 채택된다.  
  레거시 시스템에서 비동기 버스를 사용하는 경우에도, 동기화 회로를 통해 메타 안정성 문제를 완화할 수 있다.
  
따라서, 동기식 온칩 버스 인터페이스는 Metastability 문제를 줄이며, 데이터를 클럭 신호에 맞춰 전송함으로써 더 높은 안정성을 제공한다.

## 2. Wishbone Bus
- **정의**: Wishbone은 OpenCores에서 개발한 오픈 소스 칩 내부 버스 아키텍처로, 다양한 장치 간의 연결을 위한 표준화된 인터페이스를 제공한다.
- **특징**: 단순한 구조와 모듈화된 설계를 지향하며, IP 모듈을 쉽게 재사용하고 시스템 통합이 용이하도록 설계되었다.
  - **오픈 소스 버스 표준(Open Source Bus Standard)**: Wishbone은 오픈 소스 커뮤니티에서 사용되며, 누구나 사용할 수 있는 무료 버스 표준이다. 이를 통해 다양한 개발자와 회사가 이를 채택하여 사용하고 있다.
  - **동기식 버스(Synchronous Bus)**: 클럭 신호에 동기화된 버스로 메타 안정성 문제를 줄이며, 데이터 전송의 안정성과 신뢰성을 높인다.
  - **대중적인 데이터 전송 프로토콜 지원**:
    - **읽기/쓰기(Read/Write) 사이클**: Wishbone은 기본적인 읽기 및 쓰기 동작을 수행하는 사이클을 지원하여 메모리 접근이나 데이터 전송을 처리한다.
    - **블록 전송(Block Transfer) 사이클**: 다수의 데이터를 연속해서 전송할 수 있는 블록 전송 모드를 지원하여 대량의 데이터 전송 시 성능을 향상시킨다.
    - **읽기-수정-쓰기(Read-Modify-Write) 사이클**: 특정 데이터에 대해 읽기 후 수정 작업을 거쳐 쓰기를 수행할 수 있는 RMW 사이클을 지원한다. 이는 특정 메모리 위치에 대해 동시 접근이 필요한 경우 유용하다.

- **장점**: 유연성과 호환성을 제공하며, 다양한 디지털 시스템에서 사용될 수 있다. 표준화된 프로토콜을 통해 다양한 IP 코어가 쉽게 통합된다.
- **다양한 코어 연결 방식 지원**:
  - **포인트-투-포인트(Point-to-Point)**: 각 모듈이 단일 통로를 통해 연결되는 방식으로, 간단한 구조를 가집니다.
  - **공유 버스(Shared Bus)**: 다수의 모듈이 하나의 공통 버스를 통해 연결되며, 버스 아비터를 통해 각 모듈 간 우선순위를 설정한다.
  - **크로스바 스위치(Crossbar Switch)**: 여러 모듈이 동시에 데이터를 전송할 수 있는 구조로, 고성능 시스템에서 데이터 병렬 전송이 가능하다.

Wishbone은 다양한 데이터 전송 요구사항을 충족시킬 수 있는 기능을 갖추고 있어, 여러 IP 모듈을 통합하여 복잡한 시스템을 설계할 때 유용하다.

## 3. Wishbone Modules
- **SYSCON**: 동기화된 리셋과 클럭 신호를 제공하는 모듈이다. 버스 전체의 리셋과 클럭 신호를 관리한다.
- **마스터 모듈**: 데이터를 요청하고 제어 신호를 관리한다. 슬레이브에 버스 트랜잭션을 생성하며, 하나 이상의 마스터 모듈이 있을 수 있고, 각 모듈은 버스에서 특정 기능을 수행한다.
- **슬레이브 모듈**: 마스터의 요청에 응답하며, 주로 데이터를 제공하거나 저장하는 역할을 한다. 마스터가 생성한 버스 트랜잭션에 반응한다.
- **인터페이스 모듈 (INTERCON)**: 모든 모듈 인터페이스를 연결하고, 데이터를 중계하는 역할을 수행한다.
- **버스 아비터(Arbiter)**: 여러 마스터 모듈이 하나의 슬레이브 모듈에 접근하는 경우, 아비터가 중재 역할을 수행하여 우선순위를 설정한다.

Wishbone 모듈들은 SYSCON, 마스터, 슬레이브, 인터페이스 모듈 등으로 구성되어 시스템 전체의 데이터 흐름을 관리하며, 효율적이고 안정적인 데이터 전송을 지원한다.

## 4. Wishbone Interconnection
- **단일 버스 연결(Single Bus Connection)**: 모든 모듈이 하나의 공통 버스를 공유하는 방식이다. 간단한 구조로 적은 자원이 소모되지만, 대역폭이 제한된다.
- **공유 버스 연결(Shared Bus Connection)**: 다수의 모듈이 버스에 연결되며, 필요한 모듈에만 버스가 할당된다. 아비터를 통해 우선순위를 설정할 수 있다.
- **크로스바 스위치(Crossbar Switch)**: 각 모듈이 별도의 경로를 통해 상호 연결되며, 동시에 여러 전송이 가능하다. 고속 전송이 가능하지만, 복잡성과 자원 소모가 증가한다.
- **단방향 연결(Uni-direction)**: 기본적으로 1:1로 데이터를 주고받는 방식으로, 데이터가 한 방향으로만 흐르게 된다. 단방향 연결은 간단한 제어와 낮은 복잡성을 가지지만, 전송량이 증가할 경우 유연성이 부족할 수 있다.
- **포인트 투 포인트 연결(Point-to-Point Interconnection)**: 각 모듈이 서로 직접 연결되는 방식이다. 데이터를 전송하는 모듈과 수신하는 모듈이 1:1로 연결되며, 각 모듈 간의 충돌 없이 데이터가 전송될 수 있다. 고속 데이터 전송이 가능하고 전송 충돌이 발생하지 않지만, 시스템의 확장성이 떨어질 수 있다.


### 5. Wishbone Signals
- **데이터 신호(Data Signals)**: `DAT_I`, `DAT_O`는 입력 및 출력 데이터 신호이다.
- **주소 신호(Address Signals)**: `ADR_O`는 슬레이브 모듈의 메모리 주소를 지정하는 신호이다.
- **제어 신호(Control Signals)**: `WE_O`, `SEL_O`, `STB_O`, `CYC_O`, `ACK_I` 등 다양한 제어 신호가 있으며, 버스 트랜잭션을 제어하고 상태를 나타낸다.
  - **필수 신호(Minimal Signals)**:
    - `RST_I` (Reset Input): 시스템 초기화를 위한 리셋 입력 신호이다.
    - `CLK_I` (Clock Input): 클럭 입력 신호로, 모든 신호가 동기화되는 기준이다.
    - `ADR_O/I` (Address): 마스터에서 슬레이브로 주소를 지정하기 위한 신호이다.
    - `DAT_O` (Data Output): 마스터에서 슬레이브로 출력되는 데이터 신호이다.
    - `DAT_I` (Data Input): 슬레이브에서 마스터로 입력되는 데이터 신호이다.
    - `WE_O/I` (Write Enable): 쓰기 작업을 수행할 때 활성화되는 신호로, 활성 상태는 High이다.
    - `STB_O/I` (Strobe): 트랜잭션의 유효성을 나타내며, 활성 상태는 High이다.
    - `ACK_O/I` (Acknowledge): 슬레이브에서 마스터로 응답을 전달하는 신호로, 트랜잭션 완료를 나타낸다.
  - **선택적 신호(Optional Signals)**:
    - `CYC_O/I` (Cycle): 마스터에서 슬레이브로 전송되는 버스 사이클 신호로, 트랜잭션이 유효함을 나타낸다.
    - `SEL_O/I` (Bank Select): 마스터에서 슬레이브로 특정 메모리 뱅크를 선택하는 신호이다.


## 6. Wishbone Bus Transactions
- **쓰기(Write) 트랜잭션**: 마스터가 슬레이브로 데이터를 전송하며, `WE_O` 신호를 통해 쓰기 작업을 수행한다. `ACK_I` 신호로 슬레이브의 응답을 확인한다.
  - **단일 쓰기 사이클 (Single Write Cycle)**:
    - Positive Edge of clk 0  
    ![WR clk 0](https://velog.velcdn.com/images/foodinsect/post/158fedca-ceca-4e2f-a277-60c35fe8bcc3/image.png)
    마스터가 `ADR`, `DAT`, `WE`, `SEL`, `STB`, `CYC`를 활성화하여 슬레이브에 쓰기 요청을 보낸다.  
    
    - Positive Edge of clk 1  
    ![WR clk 1](https://velog.velcdn.com/images/foodinsect/post/5657032b-e208-4d37-9f96-d8813c8a7daf/image.png)
    슬레이브가 `ACK` 신호를 활성화하여 쓰기 요청을 수락했음을 알린다.  
    
    - Positive Edge of clk 2  
    ![WR clk 2](https://velog.velcdn.com/images/foodinsect/post/8545aa97-54eb-4f23-82bb-9c21d265bdb4/image.png)
    마스터가 `ADR`, `DAT`, `WE`, `SEL`, `STB`, `CYC`를 비활성화하여 트랜잭션을 종료한다.  
    슬레이브가 `ACK` 신호를 비활성화하여 응답을 완료한다.
    

- **읽기(Read) 트랜잭션**: 마스터가 슬레이브에서 데이터를 읽어온다. `STB_O`와 `CYC_O` 신호를 통해 트랜잭션을 시작하고, 슬레이브에서 `ACK_I` 신호로 응답한다.
  - **단일 읽기 사이클 (Single Read Cycle)**:
    - Positive Edge of clk 0  
    ![RD clk 0](https://velog.velcdn.com/images/foodinsect/post/fbd00d9e-579b-43a5-9ba2-8b56276f5fa1/image.png)
    마스터가 `ADR`, `WE`, `SEL`, `STB`, `CYC`를 활성화하여 슬레이브에 읽기 요청을 보낸다.
    - Positive Edge of clk 1  
    ![RD clk 1](https://velog.velcdn.com/images/foodinsect/post/93e5ab49-ab04-4ff2-a7eb-20c52e5b5f2d/image.png)
    슬레이브가 `ACK`와 `DAT` 신호를 활성화하여 데이터와 함께 응답한다.
    - Positive Edge of clk 2  
    ![RD clk 2](https://velog.velcdn.com/images/foodinsect/post/ff18b817-eb3f-40a5-a401-41f5279a5e74/image.png)
    마스터가 `ADR`, `SEL`, `STB`, `CYC`를 비활성화하여 트랜잭션을 종료한다.  
    슬레이브가 `DAT`와 `ACK` 신호를 비활성화하여 응답을 완료한다.


## 7. Handshaking Protocol
- **정의**: Handshaking은 두 모듈 간의 데이터 전송을 조율하기 위한 프로토콜이다. 신호의 요청과 응답을 통해 안전하게 데이터 전송이 이루어진다.
- **작동 원리**: 마스터는 `STB_O` 및 `CYC_O` 신호로 슬레이브에 요청을 보내고, 슬레이브는 `ACK_I` 신호로 이를 수락 또는 거부한다.
  - **시작(Start)**: 마스터가 클럭의 Positive Edge에서 `STB`와 기타 제어 신호를 활성화하여 요청을 보낸다.
  - **대기(Wait)**: 마스터는 슬레이브가 `ACK` 신호를 활성화할 때까지 대기하며, `ACK` 신호는 클럭의 Positive Edge에서 샘플링된다.
  - **응답(ACK)**: 슬레이브는 `STB`와 `ADR`이 올바르게 활성화되었을 때 `ACK` 신호를 활성화하여 응답한다.
  - **종료(Finish)**: 슬레이브의 `ACK`가 활성화된 경우, 마스터는 다음 클럭의 Positive Edge에서 `STB`와 제어 신호를 비활성화하여 트랜잭션을 종료한다.
  
- **동기식 슬레이브 vs. 비동기식 슬레이브(Synchronous vs. Asynchronous Slave)**:
  - **동기식 슬레이브**: 클럭 신호에 따라 동작하며, Handshaking 프로토콜이 클럭 엣지에서 요청과 응답이 일치하도록 조정된다. 데이터 전송이 동기적으로 이루어져 메타 안정성 문제가 최소화된다.
  - **비동기식 슬레이브**: 클럭 신호 없이 동작하는 슬레이브로, 데이터 전송 시 Handshaking 프로토콜이 더욱 중요하다. 동기식 트랜잭션보다 복잡한 제어가 필요하지만, 비동기 방식에서도 데이터 무결성을 보장할 수 있다.  
![sync vs async](https://velog.velcdn.com/images/foodinsect/post/3a5ba90b-c2c1-4be4-a366-a7afa7ae46ff/image.png)

- **장점**: Handshaking 프로토콜은 비동기적인 트랜잭션에서도 데이터 전송의 무결성을 보장하며, 모듈 간 충돌을 방지한다. 신호가 클럭 엣지에 맞춰 조정되어, 데이터 전송이 안전하고 신뢰성 있게 이루어진다.