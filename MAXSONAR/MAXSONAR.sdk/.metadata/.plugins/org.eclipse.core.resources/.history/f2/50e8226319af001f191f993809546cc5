/*
 * main.c
 *
 *  Created on: 2024. 11. 30.
 *      Author: foodbug
 */

#include "xparameters.h"
#include "xgpio.h"
#include "xil_io.h"
#include "stdio.h"

#define GPIO0_DEVICE_ID XPAR_AXI_GPIO_0_DEVICE_ID  // GPIO 입력 (PWM)
#define GPIO1_DEVICE_ID XPAR_AXI_GPIO_1_DEVICE_ID  // GPIO 출력 (LED)
#define GPIO_CHANNEL 1                             // GPIO 채널 번호

XGpio Gpio0;  // 입력 GPIO 인스턴스
XGpio Gpio1;  // 출력 GPIO 인스턴스

void init_gpio() {
    int Status;

    // GPIO0 초기화 (입력)
    Status = XGpio_Initialize(&Gpio0, GPIO0_DEVICE_ID);
    if (Status != XST_SUCCESS) {
        xil_printf("GPIO0 Initialization Failed\n");
    }
    XGpio_SetDataDirection(&Gpio0, GPIO_CHANNEL, 0xFFFFFFFF); // 입력 설정

    // GPIO1 초기화 (출력)
    Status = XGpio_Initialize(&Gpio1, GPIO1_DEVICE_ID);
    if (Status != XST_SUCCESS) {
        xil_printf("GPIO1 Initialization Failed\n");
    }
    XGpio_SetDataDirection(&Gpio1, GPIO_CHANNEL, 0x00000000); // 출력 설정
}

int main() {
    xil_printf("Starting GPIO PWM to LED Output\n");

    init_gpio();

    u32 pwm_state;

    while (1) {
        // GPIO0에서 PWM 상태 읽기
        pwm_state = XGpio_DiscreteRead(&Gpio0, GPIO_CHANNEL);

        // GPIO1로 PWM 상태 쓰기 (LED 제어)
        XGpio_DiscreteWrite(&Gpio1, GPIO_CHANNEL, pwm_state);

        xil_printf("PWM State: %d, LED Output Updated\n", pwm_state);

        // 간단한 딜레이
        for (volatile int i = 0; i < 1e6; i++);
    }

    return 0;
}
