
# 3. DigInPort - FPGA 외부 신호 입력 모듈
![Waveform](https://velog.velcdn.com/images/foodinsect/post/b9460db3-6266-439d-9ccc-6dbb5cfa02d2/image.png)
## 개요

`DigInPort` 모듈은 **FPGA 외부에서 입력되는 디지털 신호**를 처리하여, 이를 **버스 인터페이스**를 통해 마스터가 읽을 수 있도록 하는 모듈이다. 외부에서 들어오는 **비동기 신호**를 안정적으로 FPGA 내부로 전달하기 위해 **동기화기(synchronizer)**를 사용하여 metastability(메타 안정성) 문제를 해결한다. 이 모듈은 외부 신호를 FPGA 내부의 클럭 도메인에 동기화한 후, 지정된 주소에서 그 값을 읽어 마스터에게 전달한다.

---

## 동기화기(Synchronizer)와 Metastability의 위험성

### Metastability란?

**Metastability**는 비동기 신호를 FPGA 내부의 **동기 클럭 도메인**에서 처리할 때 발생할 수 있는 문제로, 신호의 값이 0과 1 사이에서 안정된 상태에 도달하지 못하는 현상이다. 이는 **비동기 신호**가 동기 클럭의 경계 시점(예: 클럭 상승 또는 하강 에지)에 들어올 경우 발생할 수 있다.

metastability가 발생하면 신호의 상태가 불안정해져 FPGA 내부의 다른 회로에 잘못된 데이터를 전달하거나, 회로 전체의 동작에 문제를 일으킬 수 있다.

### 동기화기(Synchronizer)란?

**동기화기**는 이러한 metastability 문제를 해결하기 위한 구조이다. 동기화기는 일반적으로 **D 플립플롭(DFF)**을 여러 개 직렬로 연결하여 비동기 신호가 FPGA 내부의 **동기 클럭 도메인**에서 안전하게 처리될 수 있도록 한다. 이를 통해 외부 입력 신호가 동기화된 신호로 안정적으로 변환되며, metastability 문제를 줄일 수 있다.

---

## 모듈 동작 원리

### 주요 기능

- **외부 디지털 신호 입력**: 8비트 외부 디지털 신호(`iDIn[7:0]`)를 입력받아 FPGA 내부에서 동기화된 신호로 변환한다.
- **동기화기 사용**: 3단계 **DFF 동기화기**를 통해 외부 신호를 안정적으로 동기화하고 metastability 문제를 방지한다.
![Syncronizer](https://velog.velcdn.com/images/foodinsect/post/4ab4ea8d-5569-4015-af4d-13ae991a09de/image.png)


- **버스 인터페이스**: 마스터가 **주소(`32'h0200_0800`)**로 접근하여 입력된 외부 신호 상태를 읽을 수 있도록 버스 인터페이스를 제공한다.
- **응답 신호**: 마스터의 요청이 성공적으로 처리되었음을 나타내는 **Acknowledge(`oACK`)** 신호를 활성화하여 요청이 완료되었음을 알린다.

### 입출력 신호

- **iRST (Reset)**: 리셋 신호로, High 상태일 때 모든 내부 상태를 초기화한다.
- **iCLK (Clock)**: FPGA 내부의 동기화된 클럭 신호이다. 이 신호를 기준으로 모든 동작이 동기화된다.
- **iDIn (Digital Input)**: 외부에서 들어오는 8비트 디지털 입력 신호이다. 이 신호는 동기화기를 통해 동기화된 후 내부에서 처리된다.
- **iADR (Address)**: 마스터가 신호 상태를 읽기 위해 접근하는 32비트 주소 입력이다.
- **oDAT (Data Output)**: 외부 입력 신호의 동기화된 상태를 32비트로 반환한다. (상위 24비트는 0으로 패딩된다.)
- **iSTB (Strobe)**: 마스터가 요청할 때 활성화되는 신호로, **High** 상태일 때 요청이 유효함을 나타낸다.
- **oACK (Acknowledge)**: 마스터가 보낸 요청이 성공적으로 처리되었음을 알리는 응답 신호이다.

### 동작 과정
![3번](https://velog.velcdn.com/images/foodinsect/post/8162d885-3984-4d27-a740-e88ed8d0f999/image.png)
1. **동기화기 적용**: 비동기 신호 `iDIn`은 **3단계 D 플립플롭**을 통해 FPGA 내부 클럭(`iCLK`)에 맞추어 동기화된다.
   - 첫 번째 DFF에서 외부 신호가 클럭에 맞추어 전달된다.
   - 두 번째 DFF에서 다시 동기화되며, 메타 안정성 문제를 해결한다.
   - 세 번째 DFF에서 최종적으로 동기화된 신호가 출력된다.
   
2. **주소 디코딩**: 마스터가 `32'h0200_0800` 주소로 접근하면, 동기화된 외부 신호 상태를 `oDAT[7:0]`로 반환한다. 상위 24비트는 0으로 패딩되어 32비트 데이터로 전달된다.

3. **응답 처리**: 주소가 유효하고 요청이 처리되면 **oACK** 신호가 **High** 상태로 설정되어 요청이 완료되었음을 마스터에게 알린다.

---

## 활용 예시

이 모듈은 FPGA 시스템에서 외부 장치로부터 디지털 신호를 안정적으로 처리할 때 유용한다. 특히 **외부 센서 데이터**나 **버튼 입력**과 같은 비동기 신호가 FPGA 내부에서 정확하게 동기화되어 처리될 수 있도록 하며, 시스템 전체의 신뢰성을 높일 수 있다.

### 예시:
- **외부 센서 입력 처리**: 센서로부터 들어오는 비동기 신호를 동기화하여 FPGA에서 정확하게 처리.
- **버튼 또는 스위치 상태 감지**: 외부에서 발생하는 사용자 입력 신호를 안정적으로 수집하여 FPGA에서 처리.
  
---

## 결론

`DigInPort` 모듈은 FPGA 외부에서 들어오는 비동기 신호를 안전하게 처리하고, 동기화기를 통해 metastability 문제를 방지한다. 이 모듈은 외부 입력 신호를 FPGA 클럭 도메인으로 동기화하여 신뢰성 있는 데이터를 마스터에 전달할 수 있으며, 다양한 FPGA 기반 시스템에서 활용될 수 있다.

---